﻿@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">

<head>
    <title>Pharma &mdash; Colorlib Template</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css?family=Rubik:400,700|Crimson+Text:400,400i" rel="stylesheet">
    <link rel="stylesheet" href="~/fonts/icomoon/style.css">

    <link rel="stylesheet" href="~/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/css/magnific-popup.css">
    <link rel="stylesheet" href="~/css/jquery-ui.css">
    <link rel="stylesheet" href="~/css/owl.carousel.min.css">
    <link rel="stylesheet" href="~/css/owl.theme.default.min.css">


    <link rel="stylesheet" href="~/css/aos.css">

    <link rel="stylesheet" href="~/css/style.css">
    <style>
        .product-thumbnail img {
            max-width: 100px;
            height: auto;
        }

        .input-group input {
            -moz-appearance: textfield;
        }

            .input-group input::-webkit-outer-spin-button,
            .input-group input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
    </style>
</head>

<body>

    <div class="site-wrap">

        <div class="site-navbar py-2">

            <div class="search-wrap">
                <div class="container">
                    <a href="#" class="search-close js-search-close"><span class="icon-close2"></span></a>
                    <form action="#" method="post">
                        <input type="text" class="form-control" placeholder="Search keyword and hit enter...">
                    </form>
                </div>
            </div>

            <div class="container">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="logo">
                        <div class="site-logo">
                            <a href="index.html" class="js-logo-clone">Pharma Box</a>
                        </div>
                    </div>
                    <div class="main-nav d-none d-lg-block">
                        <nav class="site-navigation text-right text-md-center" role="navigation">
                            <ul class="site-menu js-clone-nav d-none d-lg-block">
                                <li><a href="@Url.Action("Index", "Home")">Home</a></li>
                                <li class="active"><a href="@Url.Action("Index", "Shop")">Store</a></li>

                                <li ><a href="@Url.Action("Branches", "Shop")">Branches</a></li>

                            </ul>
                        </nav>
                    </div>
                    <div class="icons">

                        @if (User.Identity.IsAuthenticated)
                        {
                            <a href="@Url.Action("profile", "User")" class="icons-btn d-inline-block ">
                                <span class="icon-user"></span>
                            </a>
                        }
                        else
                        {
                            <a href="@Url.Action("Login", "User")" class="btn btn-primary">Login</a>
                        }
                        <a href="@Url.Action("Cart", "Cart")" class="icons-btn d-inline-block bag">
                            <span class="icon-shopping-bag"></span>

                        </a>
                        <a href="#" class="site-menu-toggle js-menu-toggle ml-3 d-inline-block d-lg-none">
                            <span class="icon-menu"></span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-light py-3">
            <div class="container">
                <div class="row">
                    <div class="col-md-12 mb-0">
                        <a asp-controller="Home" asp-action="Index">Home</a> <span class="mx-2 mb-0">/</span>
                        <strong class="text-black">Cart</strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="site-section">
            <div class="container">
                <div class="row mb-5">
                    <div class="col-md-12">
                        <div class="site-blocks-table">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th class="product-thumbnail">Image</th>
                                        <th class="product-name">Product</th>
                                        <th class="product-price">Price</th>
                                        <th class="product-quantity">Quantity</th>
                                        <th class="product-total">Total</th>
                                        <th class="product-remove">Remove</th>
                                    </tr>
                                </thead>
                                <tbody id="cartTableBody">
                                    <!-- Cart items will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Cart Summary -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="row mb-5">
                            <div class="col-md-6">
                                <button onclick="clearCart()" class="btn btn-outline-primary btn-lg py-3 btn-block">Clear Cart</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 pl-5">
                        <div class="row justify-content-end">
                            <div class="col-md-7">
                                <div class="row">
                                    <div class="col-md-12 text-right border-bottom mb-5">
                                        <h3 class="text-black h4 text-left text-uppercase">Cart Totals</h3>
                                    </div>
                                </div>
                                <div class="row mb-5">
                                    <div class="col-md-6">
                                        <span class="text-black h5">Total</span>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <strong class="text-black h5" id="cartTotal">0.00 JOD</strong>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <button class="btn btn-primary btn-lg py-3 btn-block"
                                                onclick="proceedToCheckout(); console.log('Button clicked');">
                                            Proceed To Checkout
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                
              
    </div>

        <footer class="site-footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-lg-3 mb-4 mb-lg-0">

                        <div class="block-7">
                            <h3 class="footer-heading mb-4">About Us</h3>
                            <p>
                                Pharma Box connects pharmacies with suppliers, streamlining orders and inventory management to improve efficiency and service.
                            </p>
                        </div>

                    </div>
                    <div class="col-lg-3 mx-auto mb-5 mb-lg-0">
                        <h3 class="footer-heading mb-4">Quick Links</h3>
                        <ul class="list-unstyled">

                            <li><a href="@Url.Action("login","user")">Login</a></li>
                            <li><a href="@Url.Action("register","user")">Register</a></li>
                            <li><a href="@Url.Action("index","Shop")">Shop</a></li>
                            <li><a href="@Url.Action("index","Home")">Home</a></li>
                        </ul>
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <div class="block-5 mb-5">
                            <h3 class="footer-heading mb-4">Contact Info</h3>
                            <ul class="list-unstyled">
                                <li class="address">123 Al-Jame'a Street, University Circle, Irbid, Jordan</li>
                                <li class="phone"><a href="tel://23923929210">079 502 4236</a></li>
                                <li class="email">Contact@pharmaBox.com</li>
                            </ul>
                        </div>


                    </div>
                </div>

            </div>
        </footer>

    @using Microsoft.AspNetCore.Antiforgery
    @inject IAntiforgery antiforgery
    @{
        var token = antiforgery.GetAndStoreTokens(Context);
    }
    <script src="~/js/jquery-3.3.1.min.js"></script>
    <script src="~/js/jquery-ui.js"></script>
    <script src="~/js/popper.min.js"></script>
    <script src="~/js/bootstrap.min.js"></script>
    <script src="~/js/owl.carousel.min.js"></script>
    <script src="~/js/jquery.magnific-popup.min.js"></script>
    <script src="~/js/aos.js"></script>

    <script src="~/js/main.js"></script>
    <!-- SweetAlert2 CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.all.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadCart();
        });

        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const tableBody = document.getElementById('cartTableBody');
            tableBody.innerHTML = '';

            if (cart.length === 0) {
                tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">Your cart is empty</td>
                        </tr>
                    `;
                updateCartTotal();
                return;
            }

            cart.forEach((item, index) => {
                const row = `
                        <tr data-id="${item.medicineId}">
                            <td class="product-thumbnail">
                                <img src="${item.imageUrl}" alt="${item.name}" class="img-fluid" style="max-width: 100px;">
                            </td>
                            <td class="product-name">
                                <h2 class="h5 text-black">${item.name}</h2>
                            </td>
                            <td class="product-price">${item.price.toFixed(2)} JOD</td>
                            <td>
                                <div class="input-group mb-3" style="max-width: 120px;">
                                    <div class="input-group-prepend">
                                        <button class="btn btn-outline-primary js-btn-minus" type="button"
                                                onclick="updateQuantity('${item.medicineId}', 'decrease')">&minus;</button>
                                    </div>
                                    <input type="text" class="form-control text-center"
                                           value="${item.quantity}"
                                           id="qty-${item.medicineId}"
                                           onchange="updateQuantity('${item.medicineId}', 'input')">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-primary js-btn-plus" type="button"
                                                onclick="updateQuantity('${item.medicineId}', 'increase')">&plus;</button>
                                    </div>
                                </div>
                            </td>
                            <td class="product-total">${(item.price * item.quantity).toFixed(2)} JOD</td>
                            <td>
                                <button onclick="removeItem('${item.medicineId}')"
                                        class="btn btn-primary height-auto btn-sm">X</button>
                            </td>
                        </tr>
                    `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            updateCartTotal();
        }

        function updateQuantity(medicineId, action) {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const itemIndex = cart.findIndex(item => item.medicineId === medicineId);
            const quantityInput = document.getElementById(`qty-${medicineId}`);
            let newQuantity;

            switch (action) {
                case 'decrease':
                    newQuantity = Math.max(1, parseInt(quantityInput.value) - 1);
                    break;
                case 'increase':
                    newQuantity = parseInt(quantityInput.value) + 1;
                    break;
                case 'input':
                    newQuantity = parseInt(quantityInput.value);
                    if (isNaN(newQuantity) || newQuantity < 1) newQuantity = 1;
                    break;
            }

            cart[itemIndex].quantity = newQuantity;
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart(); // Reload the entire cart to update totals
        }

        function removeItem(medicineId) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart = cart.filter(item => item.medicineId !== medicineId);
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }

              function clearCart() {
            // Use SweetAlert2 for confirmation dialog
            Swal.fire({
                title: 'Are you sure?',
                text: 'Do you really want to clear your cart?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, clear it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // Clear the cart from localStorage
                    localStorage.removeItem('cart');
                    loadCart();
                    // Show success message after clearing the cart
                    Swal.fire('Cleared!', 'Your cart has been cleared.', 'success');
                }
            });
        }
        function updateCartTotal() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('cartTotal').textContent = `${total.toFixed(2)} JOD`;
        }

                     async function proceedToCheckout() {
            const cartItems = JSON.parse(localStorage.getItem('cart'));
            console.log('Cart Items before checkout:', cartItems); // Debug log

            if (!cartItems || cartItems.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            try {
                console.log('Attempting to send request to server...'); // Debug log
                const response = await fetch('/Cart/Checkoutt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/html'  // Add this to explicitly accept HTML response
                    },
                    body: JSON.stringify(cartItems)
                });

                console.log('Response received:', response); // Debug log

                if (response.ok) {
                    const htmlContent = await response.text();
                    console.log('HTML content received'); // Debug log
                    document.documentElement.innerHTML = htmlContent;
                    history.pushState({}, '', '/Cart/Checkoutt');
                } else {
                    console.error('Server returned error status:', response.status);
                }
            } catch (error) {
                console.error('Error during checkout:', error);
            }
        }

       
    </script>

    
</body>

</html>